<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Client</title>
	<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />

	<style>
		#message {
			position: absolute;
			right: 20px;
			bottom: 0;
		}
	</style>
</head>

<body style="overflow:hidden; margin:0; padding:0;">
	<div id="message"></div>
	<iframe src="" id="content" style="width:100vw; height:100vh; border:none"></iframe>
	<script type="text/javascript">
		const queryString = window.location.search;
		const urlParams = new URLSearchParams(queryString);
		const server = urlParams.has("server") ? urlParams.get('server') : window.location.hostname;
		const port = urlParams.has("port") ? urlParams.get('port') : "3001";
		const group = urlParams.has("group") ? urlParams.get('group') : "default";
		const hostname = urlParams.has("hostname") ? urlParams.get('hostname') : null;
		const cid = urlParams.has("cid") ? urlParams.get('cid') : null;

		let slides = [];
		let slideIndex = 0;
		let nextSlideIndx;
		let lastSlideshowReceive = null;
		let hearbeatTimeoutIndx;
		let ws_client;

		function showSlides() {
			slideIndex++;
			if (slideIndex > slides.length) {
				slideIndex = 1;
			}
			let slide = slides[slideIndex - 1];

			console.log("go to slide");
			console.log(slide);
			document.getElementById("content").src = slide.url;
			nextSlideIndx = setTimeout(showSlides, slide.duration * 1000);
		}

		function connect(initial) {

			let url = "ws://" + server + ":" + port + "?type=client&group=" + group + "&initial=" + initial;

			if (hostname !== null) {
				url = url + "&hostname=" + hostname;
			}
			if (cid !== null) {
				url = url + "&cid=" + cid;
			}

			ws_client = new WebSocket(url);

			ws_client.onopen = function () {
				document.getElementById("message").innerText = "";

				if (lastSlideshowReceive !== null) {
					ws_client.send(JSON.stringify({ "type": "get_last_send_result", "value": lastSlideshowReceive }));
				}
				heartbeat();
			};

			ws_client.onmessage = function (evt) {
				var received_msg = evt.data;
				var jsonObject = JSON.parse(evt.data);
				let type = jsonObject.type;

				if (type == "send_url") {

					if (typeof (nextSlideIndx) !== 'undefined') {
						clearInterval(nextSlideIndx);
					}

					slides = jsonObject.slideshow.slides;
					slideIndex = 0;
					lastSlideshowReceive = new Date();
					showSlides();
				}

				if (type == "get_url") {
					ws_client.send(JSON.stringify({ "type": "get_url_result", "value": document.getElementById("content").src, "admin": jsonObject.admin }));
				}

				// received hearbeat so we are still connected!
				if(type == "heartbeat"){
					heartbeat();
				}
			};

			ws_client.onclose = function (e) {
				clearTimeout(hearbeatTimeoutIndx);
				console.log('Socket is closed. Reconnect will be attempted in 10 seconds.', e.reason);
				document.getElementById("message").innerText = "Offline";
				setTimeout(function () {
					connect(false);
				}, 10000);
			};

			ws_client.onerror = function (err) {
				console.error('Socket encountered error: ', err.message, 'Closing socket');
				ws_client.close();
			};
		}

		function heartbeat(){
			clearTimeout(hearbeatTimeoutIndx);
			hearbeatTimeoutIndx = setTimeout(function(){
				ws_client.close();
			}, 30000 + 1000);
		}

        connect(true);
	</script>
</body>

</html>